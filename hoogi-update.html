<section id="nb4">
  <style>
    #nb4{background:#f6f8fb;font-family:'Noto Sans KR',sans-serif;padding:5rem 0;}
    #nb4 *{box-sizing:border-box}
    #nb4 .nb4-container{max-width:1300px;margin:0 auto;padding:0 1.5rem;}
    #nb4 .nb4-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem}
    #nb4 .nb4-title{font-size:2.25rem;line-height:2.5rem;font-weight:bold;color:#1f2937;}
    @media(min-width:768px){#nb4 .nb4-title{font-size:2rem;line-height:1.4}}
    #nb4 .nb4-nav-group{display:flex;gap:.5rem}
    #nb4 .nb4-btn{width:40px;height:40px;border:none;border-radius:9999px;background:#0f172a;color:#fff;cursor:pointer}

    #nb4 .nb4-slider-container{display:flex;overflow:hidden;padding-bottom:1.5rem;}
    #nb4 .nb4-slider-wrapper{display:flex;gap:1.5rem;transition:transform .1s ease;will-change:transform;}
    #nb4 .nb4-product-slide{
      display:block;
      width:340px;
      background:#fff;
      border-radius:.75rem;
      box-shadow:0 4px 6px rgba(0,0,0,.1),0 2px 4px rgba(0,0,0,.06);
      overflow:hidden;
      text-decoration:none;
      color:inherit;
      transition:transform .35s ease, box-shadow .35s ease;
      will-change:transform;
    }
    @media(max-width:768px){#nb4 .nb4-product-slide{width:350px}}
    
    #nb4 .case-media{position:relative;width:100%;overflow:hidden;background:#eef2f7;height:190px}
    @media(max-width:640px){#nb4 .case-media{height:160px}}
    #nb4 .case-img{width:100%;height:100%;object-fit:cover;object-position:center;}
    #nb4 .media-pin{position:absolute;top:12px;left:12px;background:rgba(255,255,255,.95);backdrop-filter:saturate(1.2) blur(6px);border:1px solid #e2e8f0;border-radius:999px;padding:.35rem .6rem;font-size:12px;font-weight:800;color:#334155}
    #nb4 .case-card{display:flex;flex-direction:column;gap:14px;padding:16px}
    #nb4 .case-top{display:flex;align-items:center;justify-content:space-between}
    #nb4 .case-pin{font-weight:800;font-size:12px;color:#475569;background:#fff;border:1px solid #e2e8f0;border-radius:999px;padding:4px 10px}
    #nb4 .kpi-band{display:grid;grid-template-columns:1fr auto;gap:14px;padding:12px;background:#f9fafb;border:1px solid #eef2f7;border-radius:12px;align-items: center;}
    #nb4 .kpi-stack{display:flex;flex-direction:column;gap:10px}
    #nb4 .kpi-box{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:4px}
    #nb4 .kpi-label{font-size:12px;color:#64748b;font-weight:800}
    #nb4 .kpi-value{font-weight:900;color:#0f172a;font-size:clamp(13px,2.4vw,18px)}
    #nb4 .rate-ring{--p:0;width:124px;height:124px;border-radius:9999px;background:conic-gradient(#16a34a calc(var(--p)*1%), #e5e7eb 0);border:8px solid #fff;display:grid;place-items:center}
    #nb4 .ring-inner{width:94px;height:94px;border-radius:9999px;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center}
    #nb4 .ring-label{font-size:11px;color:#64748b;margin-bottom:4px;font-weight:700}
    #nb4 .ring-val{font-weight:900;font-size:22px;color:#065f46}
    #nb4 .badges{display:flex;flex-wrap:wrap;gap:8px}
    #nb4 .badge{background:#eef2ff;border:1px solid #e0e7ff;color:#3730a3;padding:.42rem .66rem;border-radius:999px;font-size:12px;font-weight:800}
    #nb4 .case-title{margin:6px 0 4px;font-weight:900;color:#0f172a;font-size:1.125rem;line-height:1.4}
    #nb4 .case-desc{margin:0;color:#334155;line-height:1.6;font-size:14px}
    #nb4 .progress{display:none;width:100%;height:12px;border-radius:9999px;background:#e2e8f0;overflow:hidden;margin-top:6px}
    #nb4 .progress>span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#16a34a)}
    @media(max-width:420px){#nb4 .nb4-product-slide{width:306px}}

    /* ✅ 세로 스크롤 허용 - 슬라이더 내부에서도 페이지 스크롤 가능 */
    #nb4 .nb4-slider-container,
    #nb4 .nb4-slider-wrapper,
    #nb4 .nb4-product-slide{
      touch-action: pan-y pinch-zoom;
    }
  </style>

  <div class="nb4-container">
    <div class="nb4-head">
      <h2 class="nb4-title">실제 후기</h2>
      <div class="nb4-nav-group">
        <button id="nb4Prev" class="nb4-btn" aria-label="이전"><i class="fas fa-chevron-left"></i></button>
        <button id="nb4Next" class="nb4-btn" aria-label="다음"><i class="fas fa-chevron-right"></i></button>
      </div>
    </div>

    <div id="nb4Slider" class="nb4-slider-container">
      <div class="nb4-slider-wrapper">

        <!-- 카드 1 -->
        <a class="nb4-product-slide" >
          <div class="case-media">
            <img class="case-img" src="./img/h9.jpg" alt="소상공인 정책자금 후기 썸네일 - 음식점 운영자">
            <span class="media-pin">01 / 08</span>
          </div>
          <article class="case-card">
            <div class="case-top"><span class="case-pin">정보통신업(IT) / 사업 2년차 / 김** 님</span></div>
            <div class="kpi-band">
              <div class="kpi-stack">
                <div class="kpi-box"><span class="kpi-label">승인금액</span><span class="kpi-value">₩20,000,000</span></div>
                <div class="kpi-box"><span class="kpi-label">총 정책자금 횟수</span><span class="kpi-value">1회</span></div>
              </div>
              <div class="rate-ring" data-rate="97">
                <div class="ring-inner">
                  <div class="ring-label">금리</div>
                  <div class="ring-val">3%</div>
                </div>
              </div>
            </div>
            <div class="badges"><span class="badge">운전자금</span><span class="badge">개발비용 확보</span></div>
            <h3 class="case-title">1천 5백만원을 받을 줄 몰랐습니다.</h3>
            <p class="case-desc">프로그램 개발 진행이 지연되면서 자금 부족에 시달리고 있었어요... 1금융 대출은 엄두도 못내는 초기 스타트업이라 막막하기만 했는데 스타트업 자금은 대출이 아니라 정책자금이라는 걸 이번 기회에 알았습니다.</p>
          </article>
        </a>

        <!-- 카드 2 -->
        <a class="nb4-product-slide" >
          <div class="case-media">
            <img class="case-img" src="./img/b3.jpg" alt="소상공인 정책자금 후기 썸네일 - 도배업 대표">
            <span class="media-pin">02 / 08</span>
          </div>
          <article class="case-card">
            <div class="case-top"><span class="case-pin">도배업 / 사업 5년차 / 윤** 님</span></div>
            <div class="kpi-band">
              <div class="kpi-stack">
                <div class="kpi-box"><span class="kpi-label">승인금액</span><span class="kpi-value">₩30,000,000</span></div>
                <div class="kpi-box"><span class="kpi-label">총 정책자금 횟수</span><span class="kpi-value">1회</span></div>
              </div>
              <div class="rate-ring" data-rate="97">
                <div class="ring-inner">
                  <div class="ring-label">금리</div>
                  <div class="ring-val">2.7%</div>
                </div>
              </div>
            </div>
            <div class="badges"><span class="badge">장비 교체 · 공사 차량 보수</span></div>
            <h3 class="case-title">공사 범위를 늘렸습니다.</h3>
            <p class="case-desc">오래된 장비로 작업 효율이 떨어져 고민이 많았는데, 정책자금을 통해 도배 장비 교체와 차량 정비를 진행했습니다. 덕분에 현장 일정이 빨라지고 고객 문의도 꾸준히 늘어나 매출이 크게 개선되었습니다.</p>
          </article>
        </a>

        <!-- 카드 3 -->
        <a class="nb4-product-slide" >
          <div class="case-media">
            <img class="case-img" src="./img/b4.jpg" alt="소상공인 정책자금 후기 썸네일 - 안경점 대표">
            <span class="media-pin">03 / 08</span>
          </div>
          <article class="case-card">
            <div class="case-top"><span class="case-pin">안경점 / 사업 7년차 / 정** 님</span></div>
            <div class="kpi-band">
              <div class="kpi-stack">
                <div class="kpi-box"><span class="kpi-label">승인금액</span><span class="kpi-value">₩50,000,000</span></div>
                <div class="kpi-box"><span class="kpi-label">총 정책자금 횟수</span><span class="kpi-value">1회</span></div>
              </div>
              <div class="rate-ring" data-rate="97">
                <div class="ring-inner">
                  <div class="ring-label">금리</div>
                  <div class="ring-val">3.1%</div>
                </div>
              </div>
            </div>
            <div class="badges"><span class="badge">운전자금 · 재고 확보</span></div>
            <h3 class="case-title">매장 운영이 한결 안정됐습니다.</h3>
            <p class="case-desc">안경 렌즈 원가와 임대료가 계속 오르면서 운영비 부담이 커졌는데, 대출이 어려워 정책자금 통해 재고를 안정적으로 확보하고 광고비 일부도 충당했습니다. 덕분에 매출 변동이 줄고, 신규 고객 유입도 늘어나 매장 운영이 한결 여유로워졌습니다.</p>
          </article>
        </a>

        <!-- 카드 4 -->
        <a class="nb4-product-slide" >
          <div class="case-media">
            <img class="case-img" src="./img/b5.jpg" alt="소상공인 정책자금 후기 썸네일 - 귀금속 매장 대표">
            <span class="media-pin">04 / 08</span>
          </div>
          <article class="case-card">
            <div class="case-top"><span class="case-pin">귀금속 / 사업 8년차 / 김** 님</span></div>
            <div class="kpi-band">
              <div class="kpi-stack">
                <div class="kpi-box"><span class="kpi-label">승인금액</span><span class="kpi-value">₩50,000,000</span></div>
                <div class="kpi-box"><span class="kpi-label">총 정책자금 횟수</span><span class="kpi-value">2회</span></div>
              </div>
              <div class="rate-ring" data-rate="97">
                <div class="ring-inner">
                  <div class="ring-label">금리</div>
                  <div class="ring-val">2.4%</div>
                </div>
              </div>
            </div>
            <div class="badges"><span class="badge">매장 인테리어 리뉴얼 · 진열 시스템 개선</span></div>
            <h3 class="case-title">매장 분위기가 달라졌어요.</h3>
            <p class="case-desc">오래된 진열장과 조명 때문에 제품이 제대로 돋보이지 않았는데, 정책자금을 통해 인테리어를 전면 리뉴얼했습니다. 조명 색감부터 진열대 높이, 벽면 톤까지 새로 맞추니 이제 손님들도 늘고 매출도 확실히 늘어난게 보여요.</p>
          </article>
        </a>

        <!-- 카드 5 -->
        <a class="nb4-product-slide" >
          <div class="case-media">
            <img class="case-img" src="./img/b6.jpg" alt="소상공인 정책자금 후기 썸네일 - 의류 매장 대표">
            <span class="media-pin">05 / 08</span>
          </div>
          <article class="case-card">
            <div class="case-top"><span class="case-pin">의류업 / 사업 10년차 / 박** 님</span></div>
            <div class="kpi-band">
              <div class="kpi-stack">
                <div class="kpi-box"><span class="kpi-label">승인금액</span><span class="kpi-value">₩30,000,000</span></div>
                <div class="kpi-box"><span class="kpi-label">총 정책자금 횟수</span><span class="kpi-value">1회</span></div>
              </div>
              <div class="rate-ring" data-rate="97">
                <div class="ring-inner">
                  <div class="ring-label">금리</div>
                  <div class="ring-val">3.3%</div>
                </div>
              </div>
            </div>
            <div class="badges"><span class="badge">긴급 운영자금 · 임대료 및 인건비</span></div>
            <h3 class="case-title">갑작스러운 매출 공백, 큰 숨통이 됐습니다.</h3>
            <p class="case-desc">매출이 급격히 줄고 카드 결제 대금이 밀리면서 운영이 한계에 부딪혔습니다. 은행 대출은 연체 이력 때문에 연이어 거절돼 정말 막막했는데, 정책자금 상담을 통해 긴급 운영자금을 빠르게 지원받을 수 있었습니다.</p>
          </article>
        </a>

        <!-- 카드 6 -->
        <a class="nb4-product-slide" >
          <div class="case-media">
            <img class="case-img" src="./img/b8.jpg" alt="소상공인 정책자금 후기 썸네일 - 치킨 프랜차이즈 대표">
            <span class="media-pin">06 / 08</span>
          </div>
          <article class="case-card">
            <div class="case-top"><span class="case-pin">치킨 프랜차이즈 / 사업 7년차 / 최** 님</span></div>
            <div class="kpi-band">
              <div class="kpi-stack">
                <div class="kpi-box"><span class="kpi-label">승인금액</span><span class="kpi-value">₩40,000,000</span></div>
                <div class="kpi-box"><span class="kpi-label">총 정책자금 횟수</span><span class="kpi-value">1회</span></div>
              </div>
              <div class="rate-ring" data-rate="97">
                <div class="ring-inner">
                  <div class="ring-label">금리</div>
                  <div class="ring-val">2.6%</div>
                </div>
              </div>
            </div>
            <div class="badges"><span class="badge">긴급 운영자금 · 배달 플랫폼 수수료 부담 완화</span></div>
            <h3 class="case-title">“기름값·수수료 다 올라서 힘들었는데 귀중한 자금줄이 되었어요.”</h3>
            <p class="case-desc">배달 수수료랑 식자재 단가가 한꺼번에 오르면서 매달 적자를 보던 상황이었습니다. 은행에서는 신용점수 때문에 연달아 거절됐는데, 정책자금으로 긴급 운영비를 확보할 수 있었어요. 덕분에 밀린 납품 대금과 월세를 정리하고, 매장 조명·간판까지 새로 손봤습니다.</p>
          </article>
        </a>

        <!-- 카드 7 -->
        <a class="nb4-product-slide" >
          <div class="case-media">
            <img class="case-img" src="./img/b9.jpg" alt="소상공인 정책자금 후기 썸네일 - 베이커리 대표">
            <span class="media-pin">07 / 08</span>
          </div>
          <article class="case-card">
            <div class="case-top"><span class="case-pin">베이커리 / 사업 7년차 / 한** 님</span></div>
            <div class="kpi-band">
              <div class="kpi-stack">
                <div class="kpi-box"><span class="kpi-label">승인금액</span><span class="kpi-value">₩30,000,000</span></div>
                <div class="kpi-box"><span class="kpi-label">총 정책자금 횟수</span><span class="kpi-value">1회</span></div>
              </div>
              <div class="rate-ring" data-rate="97">
                <div class="ring-inner">
                  <div class="ring-label">금리</div>
                  <div class="ring-val">2.6%</div>
                </div>
              </div>
            </div>
            <div class="badges"><span class="badge">운전자금 · 설비 교체</span></div>
            <h3 class="case-title">성장의 발판이 되었습니다.</h3>
            <p class="case-desc">단골 손님이 꾸준히 늘고 매출도 오르고 있었지만, 오븐 증설과 인력 확장 타이밍을 놓치고 있었습니다. 정책자금 상담을 통해 성장자금을 지원받을 수 있었어요. 그 자금으로 설비를 교체하고 생산량을 늘리니, 하루 판매량이 이전보다 1.5배 이상 올라 매장 운영이 훨씬 안정됐습니다.</p>
          </article>
        </a>

        <!-- 카드 8 -->
        <a class="nb4-product-slide" >
          <div class="case-media">
            <img class="case-img" src="./img/b1.jpg" alt="소상공인 정책자금 후기 썸네일 - 이삿집 대표">
            <span class="media-pin">08 / 08</span>
          </div>
          <article class="case-card">
            <div class="case-top"><span class="case-pin">이삿집 / 사업 7년차 / 이** 님</span></div>
            <div class="kpi-band">
              <div class="kpi-stack">
                <div class="kpi-box"><span class="kpi-label">승인금액</span><span class="kpi-value">₩80,000,000</span></div>
                <div class="kpi-box"><span class="kpi-label">총 정책자금 횟수</span><span class="kpi-value">2회</span></div>
              </div>
              <div class="rate-ring" data-rate="97">
                <div class="ring-inner">
                  <div class="ring-label">금리</div>
                  <div class="ring-val">2.6%</div>
                </div>
              </div>
            </div>
            <div class="badges"><span class="badge">운전자금 · 긴급 유동성 확보</span></div>
            <h3 class="case-title">“급한 자금 압박, 다행히 해결해줬어요.”</h3>
            <p class="case-desc">갑자기 들어온 대형 이사 계약이 취소되면서 현금 흐름이 막혔습니다. 차량 유지비, 기사 인건비, 창고 임대료까지 한꺼번에 밀리며 정말 숨이 막히는 시기였죠. 은행 문턱은 택도 없고 절박하게 찾다가 여기에서 승인받아 다행히 잘 해결했습니다. 진짜 정말 감사합니다.</p>
          </article>
        </a>

      </div>
    </div>
  </div>
</section>

<!-- ▶ 원형 게이지 & KPI 카운팅 (IntersectionObserver) -->
<script>
(() => {
  const root = document.getElementById('nb4');
  if (!root) return;
  const EASE = (t) => 1 - Math.pow(1 - t, 3);
  const DURATION = 900;

  const fmtComma = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');

  function parseCurrencyParts(text) {
    const mAll = [...text.matchAll(/(\d[\d,]*)/g)];
    if (!mAll.length) return null;
    const m = mAll[mAll.length - 1];
    const start = m.index, len = m[0].length;
    const num = parseInt(m[0].replace(/,/g, ''), 10) || 0;
    return { prefix: text.slice(0, start), suffix: text.slice(start + len), number: num };
  }
  function parseLastNumberParts(text) {
    const mAll = [...text.matchAll(/(\d[\d,]*)/g)];
    if (!mAll.length) return null;
    const m = mAll[mAll.length - 1];
    const start = m.index, len = m[0].length;
    const num = parseInt(m[0].replace(/,/g, ''), 10) || 0;
    return { head: text.slice(0, start), tail: text.slice(start + len), number: num };
  }
  function findKpiValueEl(cardEl, labelText) {
    const boxes = cardEl.querySelectorAll('.kpi-box');
    for (const box of boxes) {
      const lbl = box.querySelector('.kpi-label');
      const val = box.querySelector('.kpi-value');
      if (lbl && val && lbl.textContent.trim() === labelText) return val;
    }
    return null;
  }
  function driveCountingForCard(cardEl, progress) {
    const amtEl = findKpiValueEl(cardEl, '승인금액');
    if (amtEl) {
      if (!amtEl.dataset.orig) amtEl.dataset.orig = amtEl.textContent.trim();
      if (!amtEl._parts) amtEl._parts = parseCurrencyParts(amtEl.dataset.orig);
      const p = amtEl._parts;
      if (p) amtEl.textContent = p.prefix + fmtComma(Math.round(p.number * progress)) + p.suffix;
    }
    const cntEl = findKpiValueEl(cardEl, '총 정책자금 횟수');
    if (cntEl) {
      if (!cntEl.dataset.orig) cntEl.dataset.orig = cntEl.textContent.trim();
      if (!cntEl._parts) cntEl._parts = parseLastNumberParts(cntEl.dataset.orig);
      const p2 = cntEl._parts;
      if (p2) cntEl.textContent = p2.head + Math.round(p2.number * progress) + p2.tail;
    }
  }
  function resetCountingForCard(cardEl) {
    const amtEl = findKpiValueEl(cardEl, '승인금액');
    if (amtEl && amtEl.dataset.orig) amtEl.textContent = amtEl.dataset.orig;
    const cntEl = findKpiValueEl(cardEl, '총 정책자금 횟수');
    if (cntEl && cntEl.dataset.orig) cntEl.textContent = cntEl.dataset.orig;
  }
  function animateRing(el) {
    const target = Math.max(0, Math.min(100, Number(el.getAttribute('data-rate') || 0)));
    let start = null;
    el.style.setProperty('--p', 0);
    const card = el.closest('.case-card');
    function step(ts) {
      if (!start) start = ts;
      const t = Math.min(1, (ts - start) / DURATION);
      const eased = EASE(t);
      el.style.setProperty('--p', Math.round(target * eased));
      if (card) driveCountingForCard(card, eased);
      if (t < 1) el._raf = requestAnimationFrame(step);
      else el._raf = null;
    }
    if (el._raf) cancelAnimationFrame(el._raf);
    el._raf = requestAnimationFrame(step);
  }
  function resetRing(el) {
    if (el._raf) cancelAnimationFrame(el._raf);
    el._raf = null;
    el.style.setProperty('--p', 0);
    const card = el.closest('.case-card');
    if (card) resetCountingForCard(card);
  }
  const rings = Array.from(root.querySelectorAll('.rate-ring[data-rate]'));
  const io = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const el = entry.target;
      if (entry.isIntersecting) animateRing(el);
      else resetRing(el);
    });
  }, { threshold: 0.35 });
  rings.forEach((el) => io.observe(el));
})();
</script>

<!-- ▼ 슬라이더 제어 (세로 스크롤 허용 + 스냅백 방지 강화) -->
<script>
(function(){
  const root = document.getElementById('nb4');
  if(!root) return;

  const slider = root.querySelector('#nb4Slider');
  const track  = slider.querySelector('.nb4-slider-wrapper');
  const prevBtn = root.querySelector('#nb4Prev');
  const nextBtn = root.querySelector('#nb4Next');

  /* ===== 상태값/유틸 ===== */
  let currentIndex = 0;
  let maxIndex = 0;
  let cardWidth = 0;
  let gap = 0;

  function updateDimensions() {
    const cards = slider.querySelectorAll('.nb4-product-slide');
    const containerWidth = slider.clientWidth;
    if (cards.length > 0) {
      const first = cards[0];
      cardWidth = first.getBoundingClientRect().width;
      gap = parseFloat(getComputedStyle(track).gap) || 24; // 1.5rem
      const visible = Math.max(1, Math.floor((containerWidth + gap) / (cardWidth + gap)));
      maxIndex = Math.max(0, cards.length - visible);
    }
  }

  function setTransform(index, animate=true){
    const tx = -index * (cardWidth + gap);
    if(animate){
      slider.classList.add('animating');
      track.style.transition = 'transform .6s cubic-bezier(0.25,0.46,0.45,0.94)';
      track.style.transform = `translateX(${tx}px)`;
      setTimeout(()=>{
        slider.classList.remove('animating');
        track.style.transition = 'transform .1s ease';
      }, 600);
    }else{
      track.style.transition = 'transform .1s ease';
      track.style.transform = `translateX(${tx}px)`;
    }
    currentIndex = Math.max(0, Math.min(index, maxIndex));
  }
  function moveTo(index){ setTransform(Math.max(0, Math.min(index, maxIndex)), true); }

  /* ===== 버튼 ===== */
  if (prevBtn) prevBtn.addEventListener('click', ()=>{ pauseAuto(); moveTo(currentIndex-1); resumeAutoLater(); });
  if (nextBtn) nextBtn.addEventListener('click', ()=>{ pauseAuto(); moveTo(currentIndex+1); resumeAutoLater(); });

  /* ===== 드래그/스와이프 (세로 스크롤 허용 + 스냅백 방지) ===== */
  let isDragging=false, started=false;
  let startX=0, startY=0, startTX=0, curTX=0, lastX=0, lastT=0, v=0, raf=null;
  let lock = 'undecided'; // 'x' | 'y' | 'undecided'

  // 조정 포인트
  const START_LOCK_X = 12;      // X축으로 잠그기 시작할 최소 이동량(px)
  const START_LOCK_BIAS = 6;    // 히스테리시스: X가 Y보다 이만큼 더 커야 X로 간주
  const DEADZONE = 18;          // 소폭 드래그에 대한 시각 이동 억제(데드존)
  const COMMIT_RATIO = 0.25;    // 카드 폭 대비 이동이 이 비율을 넘으면 페이지 이동 커밋
  const COMMIT_MIN = 60;        // 최소 커밋 픽셀
  const FRICTION=0.95, MIN_V=0.8;

  function getTX(){
    const m = track.style.transform.match(/translateX\((-?\d+(?:\.\d+)?)px\)/);
    return m ? parseFloat(m[1]) : 0;
  }

  function onStart(e){
    if(e.type==='mousedown' && e.button!==0) return;
    isDragging=true; started=false; lock='undecided';
    const p = e.touches ? e.touches[0] : e;
    startX = lastX = p.clientX;
    startY = p.clientY;
    startTX = getTX(); curTX=startTX;
    lastT=performance.now(); v=0;
    slider.classList.add('dragging');
    // 세로 스크롤 살리기 위해 여기서는 preventDefault() 하지 않음
  }

  function onMove(e){
    if(!isDragging) return;
    const now = performance.now();
    const p = e.touches ? e.touches[0] : e;
    const totalDX = p.clientX - startX;
    const totalDY = p.clientY - startY;

    // 축 잠금(히스테리시스 포함)
    if (lock === 'undecided') {
      const absX = Math.abs(totalDX), absY = Math.abs(totalDY);
      if (absX > START_LOCK_X && absX > absY + START_LOCK_BIAS) {
        lock = 'x'; started = true;
      } else if (absY > START_LOCK_X && absY > absX + START_LOCK_BIAS) {
        lock = 'y';
        // 세로 판정 → 드래그 종료하고 기본 스크롤 허용
        isDragging = false;
        slider.classList.remove('dragging');
        return;
      } else {
        // 잠금 전: 아무것도 하지 않음(시각 이동 없음) → 스냅백 체감 감소
        lastX = p.clientX; lastT = now;
        return;
      }
    }

    if (lock === 'x') {
      // 가로 드래그에서만 기본 동작 차단
      e.preventDefault();

      // 데드존: 작은 이동은 저항(탄성) 적용 → "살짝 움직였다 복귀" 느낌 최소화
      let dx = totalDX;
      if (Math.abs(dx) < DEADZONE) {
        dx = Math.sign(dx) * Math.pow(Math.abs(dx)/DEADZONE, 2) * DEADZONE * 0.35; // 완만한 가속
      }

      let next = startTX + dx;
      const minT = -(maxIndex * (cardWidth + gap));
      const maxT = 0;
      if(next > maxT) next = maxT + (next - maxT)*0.3;
      else if(next < minT) next = minT + (next - minT)*0.3;

      curTX = next;
      track.style.transform = `translateX(${next}px)`;

      const dt = Math.max(1, now - lastT);
      const iv = (p.clientX - lastX) / dt;
      v = v*0.8 + iv*0.2;

      lastX = p.clientX; lastT = now;
    }
  }

  function snapOrCommit(){
    const step = cardWidth + gap;
    const moved = curTX - startTX;        // 음수면 오른쪽으로, 양수면 왼쪽으로 drag된 셈(좌표상)
    const absMoved = Math.abs(moved);
    const commitThreshold = Math.max(COMMIT_MIN, cardWidth * COMMIT_RATIO);

    // 빠른 플릭은 속도로 판정
    const velocityCommit = Math.abs(v) > MIN_V;

    let idx = currentIndex;
    if (absMoved > commitThreshold || velocityCommit) {
      // 방향에 따라 다음/이전 카드로 커밋
      if (moved < 0) idx = Math.min(currentIndex + 1, maxIndex);
      else if (moved > 0) idx = Math.max(currentIndex - 1, 0);
      setTransform(idx, true);
    } else {
      // 커밋 임계치 미만 → 현재 인덱스로 부드럽게 복귀(가벼운 스냅백)
      setTransform(currentIndex, true);
    }
  }

  function momentum(){
    if(raf) return;
    function frame(){
      if(Math.abs(v) < MIN_V){ raf=null; snapOrCommit(); return; }
      curTX += v*16; // ~60fps
      const minT = -(maxIndex * (cardWidth + gap));
      const maxT = 0;
      if(curTX > maxT || curTX < minT){
        v *= -0.3;
        curTX = Math.max(minT, Math.min(maxT, curTX));
      }
      track.style.transform = `translateX(${curTX}px)`;
      v *= FRICTION;
      raf = requestAnimationFrame(frame);
    }
    frame();
  }

  function onEnd(e){
    if(!isDragging) return;
    isDragging=false;
    slider.classList.remove('dragging');

    if (lock === 'x' && started){
      // 관성 적용 후 커밋/스냅 결정
      if(Math.abs(v) > MIN_V) momentum();
      else snapOrCommit();
      resumeAutoLater();
      if (e) e.preventDefault();
    } else {
      resumeAutoLater();
    }
  }

  slider.addEventListener('mousedown', onStart, {passive:false});
  document.addEventListener('mousemove', onMove, {passive:false});
  document.addEventListener('mouseup', onEnd, {passive:false});

  slider.addEventListener('touchstart', onStart, {passive:false});
  slider.addEventListener('touchmove', onMove, {passive:false});
  slider.addEventListener('touchend', onEnd, {passive:false});
  slider.addEventListener('touchcancel', onEnd, {passive:false});

  // 드래그 후 클릭 방지(가로 드래그의 경우만)
  slider.addEventListener('click', (e)=>{
    if(lock==='x' && started){ e.preventDefault(); e.stopPropagation(); started=false; }
  }, true);

  slider.addEventListener('dragstart', e=>e.preventDefault());

  /* ===== 자동 롤링 ===== */
  const INTERVAL = 4200;
  let auto=null, resume=null;

  function step(){
    const next = currentIndex >= maxIndex ? 0 : currentIndex+1;
    moveTo(next);
  }
  function startAuto(){ stopAuto(); auto=setInterval(step, INTERVAL); }
  function stopAuto(){ if(auto){ clearInterval(auto); auto=null; } }
  function pauseAuto(){ stopAuto(); if(resume){ clearTimeout(resume); resume=null; } }
  function resumeAutoLater(delay=6200){ if(resume) clearTimeout(resume); resume=setTimeout(()=>startAuto(), delay); }

  /* ===== 초기화 & 리사이즈 ===== */
  function init(){ updateDimensions(); setTransform(0,false); startAuto(); }
  let rTimer=null;
  window.addEventListener('resize', ()=>{
    pauseAuto(); clearTimeout(rTimer);
    rTimer=setTimeout(()=>{
      updateDimensions();
      setTransform(Math.min(currentIndex, maxIndex), false);
      resumeAutoLater();
    },200);
  });

  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden) pauseAuto(); else resumeAutoLater(1800);
  });

  init();
})();
</script>
